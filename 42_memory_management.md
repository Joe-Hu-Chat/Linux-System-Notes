---
typora-copy-images-to: ./.42_memory_management
---

2024年2月18日

# 内存管理

![img](.\.42_memory_management\wps3.jpg)

在Linux系统中，虚拟内存和物理内存都是由kernel管理的，当进程需要分配内存时，都需要通过系统调用陷入内核空间来分配，再将虚拟内存起始地址返回给用户态。内核提供了多个系统调用来分配虚拟内存，包括**brk**, **mmap**和**mremap**等。

在Linux操作系统标准**libc**库中，`malloc`函数的实现中会根据分配内存的size来决定使用哪个分配函数，当size小于/等于128KB，调用`brk`分配，当size大于128KB时，调用`mmap`分配内存。



## 分配器（allocator）

在`malloc`和系统调用之间插入一层中间件。分配器首先通过系统调用从内核批发大块内存，然后切成不同大小的内存片**缓存**起来，例如8/16/24/32/64byte等，当调用` malloc`的时候，直接从cache的空间内存片中分配；同时，为了解决性能问题，分配器对每个线程<span style="color:red">或者</span>每个cpu预留单独的cache，每个线程从自己的cache中分配，可以减少线程之间的锁竞争。

![img](.\.42_memory_management\wps7.jpg)

现在业界主流的分配器有ptmalloc, tcmalloc, jemalloc, scudo等。（这些都在libc库中吗？）

> [!CAUTION]
>
> 内核的分配器与用户空间/库函数的分配器都是什么？



### buddy system

Buddy System是一种程序，其中两个人作为一个单元一起操作，以便他们能够相互监视和帮助。 Buddy System的主要优点是提高安全性，每个人都可以防止另一个人成为伤亡者或在危机中拯救另一个人。当这个系统作为培训或新来组织的新手引导的一部分时，经验不足的伙伴通过与经验丰富的伙伴的密切和频繁的接触更快地学习，而不是独自操作。 Buddy System在美国武装部队中使用，并在每个分支中以不同的名称（空军中的“Wingmen”，陆军中的“Battle Buddies”，海军中的“Shipmates”）以及美国男童军和美国女童军中使用。

此外，Buddy System还被广泛用于新员工的引入和知识共享。它涉及将新员工分配给工作场所的伙伴。伙伴是指导新项目经理在工作的前几周或几个月中的现有员工。 Buddy System是一种有效的方法，可以提供支持，监测压力并强化安全程序。

Buddy System Memory Allocator是指用二进制拆分的方法来管理内存。以2幂次方大小的形式组织这些内存块，每个块都有一个大小相等的伙伴。

### slab分配器

预先分配一些常见大小的内存块（slabs）来管理内存。

SLUB Sparse, Local, and Unreliable Buddy allocator.



## mm_struct

![img](.\.42_memory_management\wps74.jpg)

（由于内核页表被映射到了所有的虚拟地址空间，在使用lazy context时，只有在切换到不同的用户进程的时候，才switch_mm，因此用active_mm来记录现在使用的是哪个用户进度空间。可用于copyfromuser之类的系统调用？）

struct mm_struct是每个task的虚拟内存空间的描述符，例如用户态进（线程）程栈区间，堆区间的地址和大小等；每个进程只有一个mm，即使是多个线程的进程，所有的线程都共享同一个mm，mm_struct数据结构中几个关键字段的含义如下：

![img](.\.42_memory_management\wps112.jpg)

在一个mm中，所有的vma通过两种结构管理起来，一个是双向链表，一个是红黑树。当遍历这个虚拟地址空间时，通过双向链表是常用的方法；当在虚拟地址空间查找vma时，通过红黑树是更便捷的方法。通常两种方法结合起来使用，例如通过红黑树查找到某个vma，后要找到该vma的前置，则直接通过vma->vm_prev就可以直接获取。

![img](.\.42_memory_management\wps153.jpg)

### 红黑树：自平衡二叉搜索树

平衡性保证，在最坏的情况下，基本的动态操作（插入，删除和查找）都有较低的时间复杂度。

 

红黑树性质：

1. 每个节点要么是黑色要么是红色
2. 根节点为黑色
3. leaf **空**节点为黑色
4. 红色节点不能相连（红色节点的子节点都得为黑色）
5. 从任意节点到leaf节点的黑色高度（简单路径包括黑色节点的数目）相同

 

这些性质保证了，在插入或删除节点后，树的结构仍然相对平衡。

在实际操作中，红黑树的操作复杂度保持在O(log n)级别，n是树中元素的个数。

 

O表示法：表示渐进复杂度的上界，用于描述最坏情况下的运行的时间或空间复杂度。

log n：以2为底的对数，红黑树的高为h = log2n。

 

红黑树通过平衡操作，使二叉树的高度最小，操作复杂度即O(h)最小。

ref: [红黑树的原理 (插入+ 删除) 案例分析 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/166319823)



红色节点通常表示该节点是一个**临时节点**，用于维护红黑树的**平衡性**。增加了一个不平衡高度

黑色节点则表示该节点是一个稳定节点，用于存储红黑树数据。它们代表了平衡高度（呼应红黑树性质5）黑色可以理解为红黑树的底色，leaf空节点为黑色。

新加入节点就增加了不平衡性，它所在的分支就变长一个节点。因此，将其**着红色**以标记节点所在的分支**不平衡**。每个红色节点代表**不平衡的值**增加1。那么修复平衡时，就可以参考节点的红黑色来分情况操作了。连续两个红色节点，代表**父节点所在的分支**比另一个分支长两个节点，即**不平衡的值达到2**（如果叔父节点也是红色，则抵消一个）。

加入一个节点为红色，减少一个节点为**反红色**，即这个节点需要变成红色，然后再被删除掉。



**不平衡上/下移**：

- 状态1：两个子节点都为红色，父节点为黑色。
- 状态2：两个子节点都为黑色，父节点为红色。
- 上移：从状态1变为状态2
- 下移：从状态2 变为状态1



不平衡**上移延迟**：

当新插入节点的兄弟节点为红色节点，就可以进行不平衡上移。为了减少不必要的操作以提高效率，这个操作并未作为红黑树的性质作要求。而是延迟不平衡上移的操作到再有新子节点加入，导致连续两个红色节点出现。在这之前，如果要删除其中一个红色节点，就可以直接删除，而不需要修复平衡的操作。

 

***\*不平衡上借\****：

不平衡下移时，如果父节点原本就是黑色，就需要向上借红，因此叫不平衡**上借**。一直递归到父节点或者兄弟节点为红色（这时会通过**左右旋借**来修复平衡）。如果递归到根节点，则将根节点变红，然后不平衡下移。

 

***\*不平衡下借\****：

左/右旋时，如果右/左子节点为黑色，且其子节点为红色节点，就可以向**下借**，因此叫不平衡下借。实际上是强迫右/左子节点的子节点**不平衡上移**。以右/左子节点为当前节点，如果一个子节点为leaf空节点（黑色），将leaf空节点变红，然后不平衡上移。

 

本质上，根节点即是红色也是黑色，或者可以叫**红黑节点**。leaf空节点也为红黑节点。（**黑中带红**）



递归：

插入节点从leaf空节点插入，删除节点也是将要删除的节点**替换**到leaf节点再删除。因此，红黑树的平衡是从最末节点开始，向上到根节点，一层一层地进行维护/修复的。依据红黑树的五个性质每次维护一个节点的两子树分支平衡，然后将同样的操作**递归**到上一层节点。递归的条件是性质4，即祖父节点与祖祖节点都为红色。如果不满足，则修复结束。

 

红黑树平衡操作：

- 着色： 每个节点被赋于红色或黑色
- 左旋/右旋： 将（右/左）子节点**提升**为父节点，左旋和右旋操作互逆
- **插入**修复： 通过旋转或着色保证树的平衡性
- **删除**修复： 通过旋转或着色保证树的平衡性

**左旋左旋的意义**：

二叉树中，每个分叉的左中右三个节点都是从小到大排列的（二叉树的有序性）。当一个**左节点右旋**：使其**代替父节点的位置**，并将**父节点变为其右子节点**，**右子节点成为父节点的左子节点**；反之亦然。旋转后依然符合二叉树中，节点从左到右值增大的顺序。左右旋都使当前节点代替了其父节点的位置，旋转后子节点之前的分支长度减1而另一边的分支加1，因此修复了平衡。

![img](.\.42_memory_management\wps199.jpg)

由于**右旋**转过程中，需要将**右子节点的位置**划给父节点，然后将**右子节点**作为父节点的左子节点，如果此**新插入节点位置在右子节点**，那么就会过平衡。即，右旋的同时，把红色右子节点也移到了右边分支。因此，对于两个连续红色节点中，父节点为左节点，子节点为右节点的，需要先通过左旋，将父子节点转到左侧。之后，再进行右旋来修复平衡。
左旋右旋着色：
旋转使一个**节点子树**从父节点的一侧移到了另一侧，左旋往左移，右旋往右移。**子节点红色**也左/右移。从孙节点位置**升上来的子节点树**或者从子节点位置**降下来的孙节点树**，保持其原来颜色（节点及其位置颜色一起上升/下降）。
红黑树中，颜色是跟着位置走的，即节点变换位置后，继承原位置的颜色。旋转调整了分支不平衡性，因此才变换了红色的位置，旋转带动分支上移时，也带动了红色的上移。
左右旋时，**父节点位置的节点**保持其原本颜色。

![img](.\.42_memory_management\wps266.jpg) -> ![img](.\.42_memory_management\wps297.jpg)

删除节点时会有**特有情况**如下：

- 如果被删除leaf子节点为黑色，**兄弟节点为黑色**且有子节点（一定是红色），则适用于旋转方法来修复平衡。旋转的目地是将要删除的节点转换为红色，实现预平衡。
- 这时，兄弟节点一定没有黑色子节点（基于红黑树性质5）。这样就分成两个红色子节点和红色子节点+leaf空节点两种情况。前一种可以直接做**不平衡上移**，后一种先从**leaf空节点借红**，再做不平衡上移。然后就可以通过左/右旋来把红色转移到被删除节点这一侧。
- 旋转后，要删除的节点变成了旋转支点的**孙节点**，而它的父节点位置获得了旋转转移过来的红色。此时，可以做不平衡下移，将**被删除节点**和它的兄弟节点-leaf空节点**变红**。leaf空节点变红后，自动变黑。

![img](.\.42_memory_management\wps357.jpg)![img](.\.42_memory_management\wps415.jpg)![img](.\.42_memory_management\wps520.jpg)

二叉搜索树：

- 有序性：对于树中的每个节点，**左子树节点的值都小于自己，而右子树节点都大于自己**
- 每一个节点的内侧子节点的值都比父节点的值离自己更近，这是左旋右旋的理论基础
- 惟一性：不存在两个节点有相同的值

如果二叉树平衡，树的高度就最小，即最坏情况下的操作复杂度保持在O(log n)级别。



红黑树插入：

- 按二叉搜索树插入，**新节点着红色**

  - 类似于搜索操作，找到适合的leaf空节点位置，然后插入
  - 从根节逐层递归，直到树末端的leaf空节点

- 修复平衡性

  - 父节点为黑色，满足性质4。

  - 父节点为红色，不满足性质4，需要再平衡。

  - 父叔节点都为红色，可以通过不平衡上移来在父节点满足性质4。

    需要将父叔节点变黑（平衡了），把祖父节点变红（不平衡上移，然后在祖父节点递归维护平衡性）

  - 父节点为红色，叔节点为黑色（空leaf节点），则**父节点这一级不平衡**

    由于二叉树中，每个分叉的左中右三个节点都是从小到大排列的，左旋和右旋分别代表了将支点左侧和右侧分支缩短一节，同是另外一侧会变长。因此，父节点为红色（叔节点为null）代表当前分支过长，需要平衡（通过左旋右旋）



红黑树删除：

- 按二叉搜索树的方式目标节点，然后由**前驱或后继**leaf节点**替换**，然后删除leaf节点位置。

  ​	前驱leaf节点为左子树最大值，后继leaf节点为右子树最小值。

  ​	将要删除的末端节点**转换为红色，再删除，树还是平衡的**。

  ​	因此，删除操作中平衡性的修复其实是**预平衡**操作。

- 修复平衡性

  - 删除**红色leaf节点**不破坏平衡性
  - 删除**黑色leaf节点**，需要修复。（基本逻辑是**将要删除的leaf节点先转换红色**）
    - 要么兄弟节点为黑色，无子节点（逻辑简单，不平衡上借）
    - 要么兄弟节点为黑色，只有红色子节点（左/右旋，将红色借过来）
    - 要么兄弟节点为红色，两个黑色子节点（左/右旋，将红色借过来）



性质4，为什么不能有两个连续的红色节点？
红色节点源于新插入节点，一条分支上有两个连续红色节点，说明这个分支变得比其它分支长了，而且长出了两个节点，需要平衡一下了。（分配到两个分支上，各分一个，这两个分支就回到了之前的平衡状态）

插入时修复平衡操作背后的意义：
每次插入都是从最末端下的leaf 空节点，插入时着红色代表增加了不平衡。当父节点也为红色，代表这次插入使**父级节点以下分支的不平衡性**从1增加到2。这时，就可以修复平衡了。
这也是性质4，红色节点不能相连的原因。

性质5，黑色高度是如何保证的？

- 新插入节点着红色

- 将红色节点变黑时，只影响其**上层节点的黑色高度**，必然要将它所在分支上的上层一个节点变红，以维持黑色高度并将不平衡标记上移。

  - 插入节点时，触发修复平衡操作时，如果两个子节点都为红色，则**不平衡上移**以维持上层节点的黑色高度的同时满足性质4。

  - 删除节点时，触发修复平衡操作时，如果两个子节点都为黑色，则**不平衡上借**以维持上层节点的黑色高度的同时将被删除节点变红。

- 删除黑色节点，要为它借一个红色来维持平衡。（预平衡：**上借，左右旋借**）

- 根节点如果**被变红**，由于其没有上层节点，可以自动变黑，这样所有分支的黑色高度加1

- 根节点如果**被借红**，由于其没有上层节点，可以自动变红，这样所有分支的黑色高度减1

- leaf空节点如果**被变红**，由于其中没有数据，可以直接删除，这样就又变成了黑色。

- leaf空节点如果**被借红**，可以假设先插入无效数据变红，之后再删除，这样就又变成了黑色。


